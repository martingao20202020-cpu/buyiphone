<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>iPhone Trading Tracker</title>
<style>
:root {
  --primary: #007AFF;
  --danger: #FF3B30;
  --success: #34C759;
  --warning: #FF9500;
  --bg: #F2F2F7;
  --card: #FFFFFF;
  --text: #1C1C1E;
  --text2: #8E8E93;
  --border: #E5E5EA;
  --radius: 12px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: calc(70px + var(--safe-bottom));
  overflow-x: hidden;
}
/* Header */
.header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(242,242,247,0.9);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  padding: 12px 16px 8px;
  border-bottom: 0.5px solid var(--border);
}
.header h1 { font-size: 28px; font-weight: 700; }
.header .date-nav {
  display: flex; align-items: center; gap: 12px; margin-top: 8px;
}
.header .date-nav button {
  background: none; border: none; font-size: 20px; color: var(--primary); cursor: pointer; padding: 4px 8px;
}
.header .date-nav .current-date {
  font-size: 16px; font-weight: 600; flex: 1; text-align: center; cursor: pointer;
}

/* Tab bar */
.tab-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  display: flex;
  border-top: 0.5px solid var(--border);
  padding-bottom: var(--safe-bottom);
}
.tab-bar .tab {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  padding: 6px 0 4px; font-size: 10px; color: var(--text2);
  background: none; border: none; cursor: pointer; gap: 2px;
}
.tab-bar .tab.active { color: var(--primary); }
.tab-bar .tab .tab-icon { font-size: 22px; }

/* Page */
.page { display: none; padding: 12px 16px 20px; }
.page.active { display: block; }

/* Card */
.card {
  background: var(--card); border-radius: var(--radius);
  padding: 16px; margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.card-title {
  font-size: 13px; font-weight: 600; color: var(--text2);
  text-transform: uppercase; letter-spacing: 0.5px;
  margin-bottom: 12px;
}

/* Form */
.form-group { margin-bottom: 14px; }
.form-group label {
  display: block; font-size: 13px; font-weight: 500; color: var(--text2); margin-bottom: 6px;
}
.form-group input, .form-group select {
  width: 100%; padding: 10px 12px; border: 1px solid var(--border);
  border-radius: 8px; font-size: 16px; background: var(--bg);
  -webkit-appearance: none; appearance: none;
}
.form-group select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M6 8L1 3h10z' fill='%238E8E93'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}
.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }

/* Buttons */
.btn {
  width: 100%; padding: 14px; border: none; border-radius: 10px;
  font-size: 16px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.btn-primary { background: var(--primary); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-success { background: var(--success); color: white; }
.btn-outline {
  background: transparent; color: var(--primary);
  border: 1.5px solid var(--primary); margin-top: 8px;
}
.btn-sm { padding: 8px 14px; font-size: 14px; width: auto; border-radius: 8px; }

/* Record list */
.record-item {
  display: flex; align-items: center; padding: 12px 0;
  border-bottom: 0.5px solid var(--border);
}
.record-item:last-child { border-bottom: none; }
.record-icon {
  width: 40px; height: 40px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; margin-right: 12px; flex-shrink: 0;
}
.record-icon.buy { background: #E3F2FD; }
.record-icon.sell { background: #E8F5E9; }
.record-info { flex: 1; min-width: 0; }
.record-info .title { font-size: 15px; font-weight: 600; }
.record-info .subtitle { font-size: 12px; color: var(--text2); margin-top: 2px; }
.record-amount { text-align: right; flex-shrink: 0; margin-left: 8px; }
.record-amount .amount { font-size: 15px; font-weight: 600; }
.record-amount .label { font-size: 11px; color: var(--text2); }

/* Stats */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.stat-box {
  background: var(--bg); border-radius: 10px; padding: 14px; text-align: center;
}
.stat-box .stat-value { font-size: 22px; font-weight: 700; }
.stat-box .stat-label { font-size: 11px; color: var(--text2); margin-top: 4px; }
.stat-box.profit .stat-value { color: var(--success); }
.stat-box.loss .stat-value { color: var(--danger); }

/* Badge */
.badge {
  display: inline-block; padding: 2px 8px; border-radius: 6px;
  font-size: 11px; font-weight: 600;
}
.badge-blue { background: #E3F2FD; color: #1565C0; }
.badge-orange { background: #FFF3E0; color: #E65100; }
.badge-green { background: #E8F5E9; color: #2E7D32; }

/* Calendar */
.calendar-grid {
  display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center;
}
.calendar-grid .day-header {
  font-size: 11px; color: var(--text2); font-weight: 600; padding: 8px 0;
}
.calendar-grid .day-cell {
  aspect-ratio: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  border-radius: 10px; font-size: 15px; cursor: pointer;
  position: relative; padding: 4px;
}
.calendar-grid .day-cell:active { background: var(--bg); }
.calendar-grid .day-cell.today { background: var(--primary); color: white; }
.calendar-grid .day-cell.selected { outline: 2px solid var(--primary); }
.calendar-grid .day-cell.has-data::after {
  content: ''; position: absolute; bottom: 4px;
  width: 5px; height: 5px; border-radius: 50%; background: var(--primary);
}
.calendar-grid .day-cell.today.has-data::after { background: white; }
.calendar-grid .day-cell.other-month { color: var(--text2); opacity: 0.4; }
.month-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.month-nav button { background: none; border: none; font-size: 20px; color: var(--primary); cursor: pointer; padding: 8px; }
.month-nav .month-title { font-size: 17px; font-weight: 600; }

/* Delete */
.delete-btn {
  background: var(--danger); color: white; border: none;
  padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer;
  margin-left: 8px; flex-shrink: 0;
}

/* Modal */
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
  z-index: 200; align-items: flex-end; justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: var(--card); border-radius: 16px 16px 0 0;
  width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto;
  padding: 20px 16px calc(20px + var(--safe-bottom));
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
}
.modal-header h2 { font-size: 20px; font-weight: 700; }
.modal-close {
  background: var(--bg); border: none; width: 30px; height: 30px;
  border-radius: 50%; font-size: 16px; cursor: pointer; color: var(--text2);
}

/* Settings */
.settings-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 14px 0; border-bottom: 0.5px solid var(--border);
}
.settings-item:last-child { border-bottom: none; }
.settings-item .label { font-size: 16px; }
.settings-item .action { color: var(--primary); font-size: 14px; font-weight: 500; }

/* Card stats table */
.card-table { width: 100%; border-collapse: collapse; }
.card-table th {
  text-align: left; font-size: 12px; color: var(--text2); font-weight: 600;
  padding: 8px 4px; border-bottom: 1px solid var(--border);
}
.card-table td {
  padding: 10px 4px; font-size: 14px; border-bottom: 0.5px solid var(--border);
}
.card-table tr:last-child td { border-bottom: none; }

/* Empty state */
.empty-state {
  text-align: center; padding: 40px 20px; color: var(--text2);
}
.empty-state .icon { font-size: 48px; margin-bottom: 12px; }
.empty-state .text { font-size: 15px; }

/* Month picker modal */
.year-month-picker { display: flex; gap: 8px; margin-bottom: 16px; }
.year-month-picker select { flex: 1; }

/* Inventory */
.inventory-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 0; border-bottom: 0.5px solid var(--border);
}
.inventory-item:last-child { border-bottom: none; }
.inventory-item .model { font-size: 15px; font-weight: 600; }
.inventory-item .count { font-size: 20px; font-weight: 700; color: var(--primary); }

/* Toast */
.toast {
  position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
  background: #333; color: white; padding: 10px 20px; border-radius: 10px;
  font-size: 14px; z-index: 999; opacity: 0; transition: opacity 0.3s;
  pointer-events: none;
}
.toast.show { opacity: 1; }
</style>
</head>
<body>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Header -->
<div class="header">
  <h1>iPhone Tracker</h1>
  <div class="date-nav">
    <button onclick="changeDate(-1)">&larr;</button>
    <div class="current-date" id="currentDate" onclick="showCalendarModal()"></div>
    <button onclick="changeDate(1)">&rarr;</button>
    <button onclick="goToday()" style="font-size:13px;padding:4px 10px;background:var(--primary);color:white;border-radius:8px;">Today</button>
  </div>
</div>

<!-- Pages -->

<!-- 1. Daily Records -->
<div class="page active" id="pageDailyRecords">
  <div class="stat-grid" style="margin-bottom:12px;">
    <div class="stat-box">
      <div class="stat-value" id="dayBuyCount">0</div>
      <div class="stat-label">Today Buy</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="daySellCount">0</div>
      <div class="stat-label">Today Sell</div>
    </div>
  </div>

  <div style="display:flex;gap:8px;margin-bottom:12px;">
    <button class="btn btn-primary btn-sm" style="flex:1" onclick="showBuyModal()">+ Buy Record</button>
    <button class="btn btn-success btn-sm" style="flex:1" onclick="showSellModal()">+ Sell Record</button>
  </div>

  <div class="card">
    <div class="card-title">Today's Records</div>
    <div id="dailyRecordsList"></div>
  </div>
</div>

<!-- 2. Calendar -->
<div class="page" id="pageCalendar">
  <div class="card">
    <div class="month-nav">
      <button onclick="calMonthChange(-1)">&larr;</button>
      <div class="month-title" id="calMonthTitle"></div>
      <button onclick="calMonthChange(1)">&rarr;</button>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
</div>

<!-- 3. Stats -->
<div class="page" id="pageStats">
  <div class="card">
    <div class="card-title">Month Filter</div>
    <div class="year-month-picker">
      <select id="statsYear" onchange="renderStats()"></select>
      <select id="statsMonth" onchange="renderStats()">
        <option value="0">All Months</option>
        <option value="1">1Êúà</option><option value="2">2Êúà</option>
        <option value="3">3Êúà</option><option value="4">4Êúà</option>
        <option value="5">5Êúà</option><option value="6">6Êúà</option>
        <option value="7">7Êúà</option><option value="8">8Êúà</option>
        <option value="9">9Êúà</option><option value="10">10Êúà</option>
        <option value="11">11Êúà</option><option value="12">12Êúà</option>
      </select>
    </div>
  </div>

  <div class="stat-grid" style="margin-bottom:12px;">
    <div class="stat-box">
      <div class="stat-value" id="statBuyTotal">¬•0</div>
      <div class="stat-label">Buy Total</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="statSellTotal">¬•0</div>
      <div class="stat-label">Sell Total</div>
    </div>
    <div class="stat-box" id="profitBox">
      <div class="stat-value" id="statProfit">¬•0</div>
      <div class="stat-label">Profit</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="statBuyQty">0</div>
      <div class="stat-label">Buy Qty</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Inventory (Current)</div>
    <div id="inventoryList"></div>
  </div>

  <div class="card">
    <div class="card-title">Credit Card Usage</div>
    <table class="card-table">
      <thead><tr><th>Card</th><th>Type</th><th>Total</th><th>Count</th></tr></thead>
      <tbody id="cardStatsBody"></tbody>
    </table>
  </div>
</div>

<!-- 4. Settings -->
<div class="page" id="pageSettings">
  <div class="card">
    <div class="card-title">Data Management</div>
    <div class="settings-item">
      <span class="label">Export Data (JSON)</span>
      <button class="btn-sm btn-primary" onclick="exportData()">Export</button>
    </div>
    <div class="settings-item">
      <span class="label">Import Data (JSON)</span>
      <button class="btn-sm btn-primary" onclick="document.getElementById('importFile').click()">Import</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    </div>
    <div class="settings-item">
      <span class="label" style="color:var(--danger)">Clear All Data</span>
      <button class="btn-sm btn-danger" onclick="clearAllData()">Clear</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">About</div>
    <p style="font-size:14px;color:var(--text2);line-height:1.6;">
      iPhone Trading Tracker v1.0<br>
      Data is stored locally in your browser.<br>
      Use Export to back up your data regularly.
    </p>
  </div>
</div>

<!-- Tab Bar -->
<div class="tab-bar">
  <button class="tab active" onclick="switchTab('pageDailyRecords', this)">
    <span class="tab-icon">üìã</span>Records
  </button>
  <button class="tab" onclick="switchTab('pageCalendar', this)">
    <span class="tab-icon">üìÖ</span>Calendar
  </button>
  <button class="tab" onclick="switchTab('pageStats', this)">
    <span class="tab-icon">üìä</span>Stats
  </button>
  <button class="tab" onclick="switchTab('pageSettings', this)">
    <span class="tab-icon">‚öôÔ∏è</span>Settings
  </button>
</div>

<!-- Buy Modal -->
<div class="modal-overlay" id="buyModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Add Buy Record</h2>
      <button class="modal-close" onclick="closeModal('buyModal')">&times;</button>
    </div>
    <div class="form-group">
      <label>iPhone Model</label>
      <select id="buyModel">
        <option value="iPhone 17">iPhone 17</option>
        <option value="iPhone 17 Pro">iPhone 17 Pro</option>
        <option value="iPhone 17 Pro Max">iPhone 17 Pro Max</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="buyQty" value="1" min="1" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>Unit Price (¬•)</label>
        <input type="number" id="buyPrice" placeholder="e.g. 150000" inputmode="decimal">
      </div>
    </div>
    <div class="form-group">
      <label>Status</label>
      <select id="buyStatus">
        <option value="Ê≥®ÊñáÁ¢∫ÂÆö">Ê≥®ÊñáÁ¢∫ÂÆö</option>
        <option value="Ê≥®Êñá„ÅÇ„Çä">Ê≥®Êñá„ÅÇ„Çä</option>
        <option value="Áô∫ÈÄÅ">Áô∫ÈÄÅ</option>
      </select>
    </div>
    <div class="form-group">
      <label>Order Number</label>
      <input type="text" id="buyOrderNo" placeholder="W1234567890" maxlength="11" style="text-transform:uppercase">
    </div>
    <div class="form-group">
      <label>Buyer Name (Ë≥ºÂÖ•ÂêçÁæ©)</label>
      <input type="text" id="buyBuyerName" placeholder="Ë≥ºÂÖ•ËÄÖÂêçÂâç">
    </div>
    <div class="form-group">
      <label>Buyer Address (Ë≥ºÂÖ•‰ΩèÊâÄ)</label>
      <input type="text" id="buyBuyerAddr" placeholder="ÈÖçÈÄÅÂÖà‰ΩèÊâÄ">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="buyEmail" placeholder="email@example.com">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Card Type</label>
        <select id="buyCardType">
          <option value="VISA">VISA</option>
          <option value="MasterCard">MasterCard</option>
          <option value="JCB">JCB</option>
          <option value="AMEX">AMEX</option>
        </select>
      </div>
      <div class="form-group">
        <label>Card Last 4</label>
        <input type="text" id="buyCardLast4" maxlength="4" placeholder="1234" inputmode="numeric">
      </div>
    </div>
    <div class="form-group">
      <label>Card Amount (¬•)</label>
      <input type="number" id="buyCardAmount" placeholder="Credit card charge" inputmode="decimal">
    </div>
    <button class="btn btn-primary" onclick="saveBuyRecord()">Save Buy Record</button>
  </div>
</div>

<!-- Sell Modal -->
<div class="modal-overlay" id="sellModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Add Sell Record</h2>
      <button class="modal-close" onclick="closeModal('sellModal')">&times;</button>
    </div>
    <div class="form-group">
      <label>iPhone Model</label>
      <select id="sellModel">
        <option value="iPhone 17">iPhone 17</option>
        <option value="iPhone 17 Pro">iPhone 17 Pro</option>
        <option value="iPhone 17 Pro Max">iPhone 17 Pro Max</option>
      </select>
    </div>
    <div class="form-group">
      <label>Quantity</label>
      <input type="number" id="sellQty" value="1" min="1" inputmode="numeric">
    </div>
    <div class="form-group">
      <label>Sell Amount (¬• total)</label>
      <input type="number" id="sellAmount" placeholder="Total sell amount" inputmode="decimal">
    </div>
    <button class="btn btn-success" onclick="saveSellRecord()">Save Sell Record</button>
  </div>
</div>

<!-- Calendar Modal (date picker) -->
<div class="modal-overlay" id="calendarModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Select Date</h2>
      <button class="modal-close" onclick="closeModal('calendarModal')">&times;</button>
    </div>
    <div class="month-nav">
      <button onclick="pickerMonthChange(-1)">&larr;</button>
      <div class="month-title" id="pickerMonthTitle"></div>
      <button onclick="pickerMonthChange(1)">&rarr;</button>
    </div>
    <div class="calendar-grid" id="pickerCalendarGrid"></div>
  </div>
</div>

<script>
// ===================== STATE =====================
let selectedDate = new Date();
let calViewDate = new Date();
let pickerViewDate = new Date();

const STORAGE_KEY = 'iphone_tracker_data';

function loadData() {
  try {
    const d = localStorage.getItem(STORAGE_KEY);
    return d ? JSON.parse(d) : { buys: [], sells: [] };
  } catch { return { buys: [], sells: [] }; }
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function dateKey(d) {
  const dt = d instanceof Date ? d : new Date(d);
  return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0') + '-' + String(dt.getDate()).padStart(2,'0');
}

function formatDate(d) {
  const dt = d instanceof Date ? d : new Date(d);
  return dt.getFullYear() + '/' + (dt.getMonth()+1) + '/' + dt.getDate();
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

// ===================== TABS =====================
function switchTab(pageId, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  btn.classList.add('active');
  if (pageId === 'pageCalendar') renderCalendar();
  if (pageId === 'pageStats') { initStatsSelectors(); renderStats(); }
}

// ===================== DATE NAV =====================
function updateDateDisplay() {
  document.getElementById('currentDate').textContent = formatDate(selectedDate);
  renderDailyRecords();
}

function changeDate(delta) {
  selectedDate.setDate(selectedDate.getDate() + delta);
  updateDateDisplay();
}

function goToday() {
  selectedDate = new Date();
  updateDateDisplay();
}

// ===================== MODALS =====================
function showBuyModal() { document.getElementById('buyModal').classList.add('active'); }
function showSellModal() { document.getElementById('sellModal').classList.add('active'); }
function showCalendarModal() {
  pickerViewDate = new Date(selectedDate);
  renderPickerCalendar();
  document.getElementById('calendarModal').classList.add('active');
}
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// Click overlay to close
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('active');
  });
});

// ===================== BUY RECORD =====================
function saveBuyRecord() {
  const model = document.getElementById('buyModel').value;
  const qty = parseInt(document.getElementById('buyQty').value) || 0;
  const price = parseFloat(document.getElementById('buyPrice').value) || 0;
  const status = document.getElementById('buyStatus').value;
  const orderNo = document.getElementById('buyOrderNo').value.trim().toUpperCase();
  const buyerName = document.getElementById('buyBuyerName').value.trim();
  const buyerAddr = document.getElementById('buyBuyerAddr').value.trim();
  const email = document.getElementById('buyEmail').value.trim();
  const cardType = document.getElementById('buyCardType').value;
  const cardLast4 = document.getElementById('buyCardLast4').value.trim();
  const cardAmount = parseFloat(document.getElementById('buyCardAmount').value) || 0;

  if (qty <= 0) { toast('Please enter quantity'); return; }
  if (price <= 0) { toast('Please enter unit price'); return; }
  if (orderNo && !/^W\d{10}$/.test(orderNo)) { toast('Order# must be W + 10 digits'); return; }

  const data = loadData();
  data.buys.push({
    id: genId(),
    date: dateKey(selectedDate),
    model, qty, price, status, orderNo, buyerName, buyerAddr, email,
    cardType, cardLast4, cardAmount,
    createdAt: new Date().toISOString()
  });
  saveData(data);

  // Reset form
  document.getElementById('buyQty').value = '1';
  document.getElementById('buyPrice').value = '';
  document.getElementById('buyOrderNo').value = '';
  document.getElementById('buyBuyerName').value = '';
  document.getElementById('buyBuyerAddr').value = '';
  document.getElementById('buyEmail').value = '';
  document.getElementById('buyCardLast4').value = '';
  document.getElementById('buyCardAmount').value = '';

  closeModal('buyModal');
  updateDateDisplay();
  toast('Buy record saved!');
}

// ===================== SELL RECORD =====================
function saveSellRecord() {
  const model = document.getElementById('sellModel').value;
  const qty = parseInt(document.getElementById('sellQty').value) || 0;
  const amount = parseFloat(document.getElementById('sellAmount').value) || 0;

  if (qty <= 0) { toast('Please enter quantity'); return; }
  if (amount <= 0) { toast('Please enter sell amount'); return; }

  const data = loadData();
  data.sells.push({
    id: genId(),
    date: dateKey(selectedDate),
    model, qty, amount,
    createdAt: new Date().toISOString()
  });
  saveData(data);

  document.getElementById('sellQty').value = '1';
  document.getElementById('sellAmount').value = '';

  closeModal('sellModal');
  updateDateDisplay();
  toast('Sell record saved!');
}

// ===================== DAILY RECORDS =====================
function renderDailyRecords() {
  const data = loadData();
  const dk = dateKey(selectedDate);
  const dayBuys = data.buys.filter(b => b.date === dk);
  const daySells = data.sells.filter(s => s.date === dk);

  document.getElementById('dayBuyCount').textContent = dayBuys.reduce((s,b) => s + b.qty, 0);
  document.getElementById('daySellCount').textContent = daySells.reduce((s,b) => s + b.qty, 0);

  const container = document.getElementById('dailyRecordsList');

  if (dayBuys.length === 0 && daySells.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üì±</div><div class="text">No records for this day</div></div>';
    return;
  }

  let html = '';

  dayBuys.forEach(b => {
    const statusClass = b.status === 'Ê≥®ÊñáÁ¢∫ÂÆö' ? 'badge-blue' : b.status === 'Ê≥®Êñá„ÅÇ„Çä' ? 'badge-orange' : 'badge-green';
    const orderLink = b.orderNo ? `<a href="https://secure2.store.apple.com/jp/shop/order/list" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:underline;font-weight:600">${b.orderNo}</a>` : '';
    html += `
      <div class="record-item">
        <div class="record-icon buy">üì•</div>
        <div class="record-info">
          <div class="title">${b.model} x${b.qty}</div>
          <div class="subtitle">
            <span class="badge ${statusClass}">${b.status}</span>
            ${orderLink ? ' ' + orderLink : ''}
          </div>
          <div class="subtitle">${b.buyerName || '-'} | ${b.buyerAddr || '-'}</div>
          <div class="subtitle">${b.cardType} ****${b.cardLast4} | ${b.email || '-'}</div>
        </div>
        <div class="record-amount">
          <div class="amount" style="color:var(--danger)">-¬•${(b.price * b.qty).toLocaleString()}</div>
          <div class="label">Card: ¬•${(b.cardAmount || 0).toLocaleString()}</div>
        </div>
        <button class="delete-btn" onclick="deleteRecord('buy','${b.id}')">Del</button>
      </div>`;
  });

  daySells.forEach(s => {
    html += `
      <div class="record-item">
        <div class="record-icon sell">üì§</div>
        <div class="record-info">
          <div class="title">${s.model} x${s.qty}</div>
          <div class="subtitle">Sell</div>
        </div>
        <div class="record-amount">
          <div class="amount" style="color:var(--success)">+¬•${s.amount.toLocaleString()}</div>
        </div>
        <button class="delete-btn" onclick="deleteRecord('sell','${s.id}')">Del</button>
      </div>`;
  });

  container.innerHTML = html;
}

function deleteRecord(type, id) {
  if (!confirm('Delete this record?')) return;
  const data = loadData();
  if (type === 'buy') data.buys = data.buys.filter(b => b.id !== id);
  else data.sells = data.sells.filter(s => s.id !== id);
  saveData(data);
  updateDateDisplay();
  toast('Record deleted');
}

// ===================== CALENDAR =====================
function renderCalendar() {
  const year = calViewDate.getFullYear();
  const month = calViewDate.getMonth();
  document.getElementById('calMonthTitle').textContent = year + 'Âπ¥' + (month + 1) + 'Êúà';

  const data = loadData();
  const dateDays = new Set();
  data.buys.forEach(b => dateDays.add(b.date));
  data.sells.forEach(s => dateDays.add(s.date));

  const grid = document.getElementById('calendarGrid');
  const today = dateKey(new Date());
  const sel = dateKey(selectedDate);

  const firstDay = new Date(year, month, 1);
  const startDay = firstDay.getDay(); // 0=Sun
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  let html = '';
  ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'].forEach(d => html += `<div class="day-header">${d}</div>`);

  // Previous month fill
  const prevMonthDays = new Date(year, month, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const day = prevMonthDays - i;
    const dk = dateKey(new Date(year, month - 1, day));
    html += `<div class="day-cell other-month${dateDays.has(dk)?' has-data':''}" onclick="selectCalDate(${year},${month-1},${day})">${day}</div>`;
  }

  // Current month
  for (let d = 1; d <= daysInMonth; d++) {
    const dk = dateKey(new Date(year, month, d));
    const classes = ['day-cell'];
    if (dk === today) classes.push('today');
    if (dk === sel) classes.push('selected');
    if (dateDays.has(dk)) classes.push('has-data');
    html += `<div class="${classes.join(' ')}" onclick="selectCalDate(${year},${month},${d})">${d}</div>`;
  }

  // Next month fill
  const totalCells = startDay + daysInMonth;
  const remaining = (7 - (totalCells % 7)) % 7;
  for (let d = 1; d <= remaining; d++) {
    const dk = dateKey(new Date(year, month + 1, d));
    html += `<div class="day-cell other-month${dateDays.has(dk)?' has-data':''}" onclick="selectCalDate(${year},${month+1},${d})">${d}</div>`;
  }

  grid.innerHTML = html;
}

function selectCalDate(y, m, d) {
  selectedDate = new Date(y, m, d);
  updateDateDisplay();
  // Switch to records tab
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('pageDailyRecords').classList.add('active');
  document.querySelectorAll('.tab')[0].classList.add('active');
}

function calMonthChange(delta) {
  calViewDate.setMonth(calViewDate.getMonth() + delta);
  renderCalendar();
}

// ===================== PICKER CALENDAR =====================
function renderPickerCalendar() {
  const year = pickerViewDate.getFullYear();
  const month = pickerViewDate.getMonth();
  document.getElementById('pickerMonthTitle').textContent = year + 'Âπ¥' + (month + 1) + 'Êúà';

  const grid = document.getElementById('pickerCalendarGrid');
  const today = dateKey(new Date());
  const sel = dateKey(selectedDate);
  const firstDay = new Date(year, month, 1);
  const startDay = firstDay.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  let html = '';
  ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'].forEach(d => html += `<div class="day-header">${d}</div>`);

  const prevMonthDays = new Date(year, month, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const day = prevMonthDays - i;
    html += `<div class="day-cell other-month" onclick="pickDate(${year},${month-1},${day})">${day}</div>`;
  }
  for (let d = 1; d <= daysInMonth; d++) {
    const dk = dateKey(new Date(year, month, d));
    const classes = ['day-cell'];
    if (dk === today) classes.push('today');
    if (dk === sel) classes.push('selected');
    html += `<div class="${classes.join(' ')}" onclick="pickDate(${year},${month},${d})">${d}</div>`;
  }
  const totalCells = startDay + daysInMonth;
  const remaining = (7 - (totalCells % 7)) % 7;
  for (let d = 1; d <= remaining; d++) {
    html += `<div class="day-cell other-month" onclick="pickDate(${year},${month+1},${d})">${d}</div>`;
  }
  grid.innerHTML = html;
}

function pickDate(y, m, d) {
  selectedDate = new Date(y, m, d);
  updateDateDisplay();
  closeModal('calendarModal');
}

function pickerMonthChange(delta) {
  pickerViewDate.setMonth(pickerViewDate.getMonth() + delta);
  renderPickerCalendar();
}

// ===================== STATS =====================
function initStatsSelectors() {
  const data = loadData();
  const years = new Set();
  const now = new Date();
  years.add(now.getFullYear());
  data.buys.forEach(b => { const y = new Date(b.date).getFullYear(); if (y) years.add(y); });
  data.sells.forEach(s => { const y = new Date(s.date).getFullYear(); if (y) years.add(y); });

  const sel = document.getElementById('statsYear');
  const currentVal = sel.value;
  sel.innerHTML = '';
  [...years].sort((a,b) => b-a).forEach(y => {
    sel.innerHTML += `<option value="${y}">${y}Âπ¥</option>`;
  });
  if (currentVal && [...years].includes(parseInt(currentVal))) sel.value = currentVal;
  else sel.value = now.getFullYear();

  if (!document.getElementById('statsMonth').value) {
    document.getElementById('statsMonth').value = now.getMonth() + 1;
  }
}

function renderStats() {
  const data = loadData();
  const year = parseInt(document.getElementById('statsYear').value);
  const month = parseInt(document.getElementById('statsMonth').value); // 0 = all

  const filterDate = (d) => {
    const dt = new Date(d);
    if (dt.getFullYear() !== year) return false;
    if (month > 0 && dt.getMonth() + 1 !== month) return false;
    return true;
  };

  const filteredBuys = data.buys.filter(b => filterDate(b.date));
  const filteredSells = data.sells.filter(s => filterDate(s.date));

  const buyTotal = filteredBuys.reduce((sum, b) => sum + (b.price * b.qty), 0);
  const sellTotal = filteredSells.reduce((sum, s) => sum + s.amount, 0);
  const profit = sellTotal - buyTotal;
  const buyQty = filteredBuys.reduce((sum, b) => sum + b.qty, 0);

  document.getElementById('statBuyTotal').textContent = '¬•' + buyTotal.toLocaleString();
  document.getElementById('statSellTotal').textContent = '¬•' + sellTotal.toLocaleString();
  document.getElementById('statProfit').textContent = (profit >= 0 ? '+' : '') + '¬•' + profit.toLocaleString();
  document.getElementById('statBuyQty').textContent = buyQty;

  const profitBox = document.getElementById('profitBox');
  profitBox.className = 'stat-box ' + (profit >= 0 ? 'profit' : 'loss');

  // Inventory (all-time, not filtered)
  const inventory = {};
  data.buys.forEach(b => { inventory[b.model] = (inventory[b.model] || 0) + b.qty; });
  data.sells.forEach(s => { inventory[s.model] = (inventory[s.model] || 0) - s.qty; });

  const invContainer = document.getElementById('inventoryList');
  const models = Object.keys(inventory);
  if (models.length === 0) {
    invContainer.innerHTML = '<div class="empty-state"><div class="text">No inventory data</div></div>';
  } else {
    invContainer.innerHTML = models.map(m =>
      `<div class="inventory-item"><span class="model">${m}</span><span class="count">${inventory[m]}</span></div>`
    ).join('');
  }

  // Credit card stats (filtered by period)
  const cardMap = {};
  filteredBuys.forEach(b => {
    const key = b.cardType + ' ****' + b.cardLast4;
    if (!cardMap[key]) cardMap[key] = { type: b.cardType, last4: b.cardLast4, total: 0, count: 0 };
    cardMap[key].total += (b.cardAmount || 0);
    cardMap[key].count++;
  });

  const tbody = document.getElementById('cardStatsBody');
  const cards = Object.values(cardMap);
  if (cards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text2);padding:20px;">No card data</td></tr>';
  } else {
    tbody.innerHTML = cards
      .sort((a, b) => b.total - a.total)
      .map(c =>
        `<tr><td>****${c.last4}</td><td>${c.type}</td><td>¬•${c.total.toLocaleString()}</td><td>${c.count}</td></tr>`
      ).join('');
  }
}

// ===================== DATA MANAGEMENT =====================
function exportData() {
  const data = loadData();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'iphone_tracker_' + dateKey(new Date()) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('Data exported!');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (!imported.buys || !imported.sells) {
        toast('Invalid data format');
        return;
      }
      if (!confirm(`Import ${imported.buys.length} buy records and ${imported.sells.length} sell records? This will REPLACE all current data.`)) return;
      saveData(imported);
      updateDateDisplay();
      toast('Data imported!');
    } catch {
      toast('Failed to parse file');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function clearAllData() {
  if (!confirm('Are you sure? This will delete ALL data permanently.')) return;
  if (!confirm('REALLY delete everything?')) return;
  saveData({ buys: [], sells: [] });
  updateDateDisplay();
  toast('All data cleared');
}

// ===================== INIT =====================
updateDateDisplay();
</script>
</body>
</html>
